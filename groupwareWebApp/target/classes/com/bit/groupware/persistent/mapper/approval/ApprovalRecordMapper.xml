<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bit.groupware.persistent.mapper.approval.ApprovalRecordMapper">
	
<!-- 첫번째만 들가도록 쿼리 설계됨 수정필요함 -->
	<insert id="insertApprovalRecord" parameterType="map" statementType="PREPARED" > 
		insert into approval_record(record_no, appr_no, line_no)
		values(approval_record_seq.nextval, #{apprNo}, 
				(select min(line_no) 
				 from receiver_line 
				 where receiver_no = #{receiverNo}))
 	</insert>
	<insert id="insertApprovalRecordProcedure" parameterType="map" statementType="CALLABLE" > 
		{
			call approval_record_procedure (#{apprNo},#{receiverNo})
		}
 	</insert>

	<select id="selectApprovlaRecordList" parameterType="int" resultType="ApprovalRecordVO" statementType="PREPARED">
     	select rec.appr_no, line.line_order, emp.emp_name, rec.appr_status, rec.assign_date,
		rec.check_date, rec.confirm_date
		from approval_record rec, receiver_line line, emp_view emp
		where rec.line_no=line.line_no
		and line.line_emp_no=emp.emp_no
		and appr_no=#{apprNo}
   </select>
   
   <update id="updateApprovalRecordStatus" parameterType="ApprovalRecordVO" statementType="PREPARED">
    	update approval_record
		set appr_status=#{apprStatus},
		check_Date=#{checkDate},
		confirm_date=#{confirmDate}
		where record_no=#{recordNo}
   </update>
   
   <delete id="deleteApprovalRecord" parameterType="int" statementType="PREPARED">  
    	delete from approval_record
		where record_no=#{recordNo}
   </delete>
   
   
   <select id="selectApprovalRecallable" parameterType="int" statementType="PREPARED">
   		select t2.appr_status
   		from approval t1, approval_record t2, receiver_line t3
   		where t1.apprNo = #{apprNo}
   			and t1.apprNo = t2.apprNo 
   			and t2.line_no = t3.line_no
   			and t3.line_order = 1     
   </select>
   
</mapper>